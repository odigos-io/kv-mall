apiVersion: v1
kind: Namespace
metadata:
  name: kv-mall
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: analytics
  namespace: kv-mall
  labels:
    app: analytics
spec:
  selector:
    matchLabels:
      app: analytics
  template:
    metadata:
      labels:
        app: analytics
    spec:
      containers:
      - name: analytics
        image: registry.odigos.io/kv-mall-analytics:v0.7
        env:
        - name: KAFKA_ADDRESS
          value: kafka-service.kv-mall-infra:9092
        - name: MEMCACHED_ADDR
          value: memcached.kv-mall-infra:11211
        - name: CASSANDRA_ADDR
          value: cassandra.kv-mall-infra:9042
        - name: POSTGRESQL_ADDR
          value: postgresql://postgres:postgres@postgres.kv-mall-infra:5432/postgres?sslmode=disable
        startupProbe:
          httpGet:
            path: /health
            port: 8081
          initialDelaySeconds: 5
          periodSeconds: 5
          failureThreshold: 100
        ports:
          - name: http
            containerPort: 8081
            protocol: TCP
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: load-generator
  namespace: kv-mall
  labels:
    app: load-generator
spec:
  selector:
    matchLabels:
      app: load-generator
  template:
    metadata:
      labels:
        app: load-generator
    spec:
      containers:
        - name: load-generator
          image: registry.odigos.io/kv-mall-load-generator:v0.4
          env:
            - name: BUY_PRODUCT_INTERVAL
              value: '2s'
            - name: GET_PRODUCTS_INTERVAL
              value: '10s'
---
apiVersion: v1
kind: Service
metadata:
  name: load-generator
  namespace: kv-mall
spec:
  selector:
    app: load-generator
  ports:
    - protocol: TCP
      port: 8080
      targetPort: 8080
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: membership
  namespace: kv-mall
  labels:
    app: membership
spec:
  selector:
    matchLabels:
      app: membership
  template:
    metadata:
      labels:
        app: membership
    spec:
      containers:
        - name: membership
          image: registry.odigos.io/kv-mall-membership:v0.4
          env:
            - name: KAFKA_ADDRESS
              value: kafka-service.kv-mall-infra:9092
          ports:
            - containerPort: 8080
---
apiVersion: v1
kind: Service
metadata:
  name: membership
  namespace: kv-mall
spec:
  selector:
    app: membership
  ports:
    - protocol: TCP
      port: 8080
      targetPort: 8080
---
##################################################
# Infrastructure (only what the remaining services need)
##################################################
apiVersion: v1
kind: Namespace
metadata:
  name: kv-mall-infra
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: cassandra
  namespace: kv-mall-infra
spec:
  selector:
    matchLabels:
      app: cassandra
  replicas: 1
  template:
    metadata:
      labels:
        app: cassandra
    spec:
      containers:
        - name: cassandra
          image: cassandra:4.0
          ports:
            - containerPort: 9042
          env:
            - name: CASSANDRA_CLUSTER_NAME
              value: 'kvmall'
---
apiVersion: v1
kind: Service
metadata:
  name: cassandra
  namespace: kv-mall-infra
spec:
  selector:
    app: cassandra
  ports:
    - protocol: TCP
      port: 9042
      targetPort: 9042
---
apiVersion: apps/v1
kind: Deployment
metadata:
  annotations:
    kompose.cmd: kompose convert -f docker-compose.yml
    kompose.version: 1.28.0 (HEAD)
  labels:
    io.kompose.service: kafka
  name: kafka
  namespace: kv-mall-infra
spec:
  replicas: 1
  selector:
    matchLabels:
      io.kompose.service: kafka
  template:
    metadata:
      annotations:
        kompose.cmd: kompose convert -f docker-compose.yml
        kompose.version: 1.28.0 (HEAD)
      labels:
        io.kompose.network/tmp-default: 'true'
        io.kompose.service: kafka
    spec:
      containers:
        - name: kafka
          image: bitnamilegacy/kafka:3.9
          env:
            - name: KAFKA_CFG_PROCESS_ROLES
              value: controller,broker
            - name: KAFKA_CFG_NODE_ID
              value: '0'
            - name: KAFKA_CFG_ADVERTISED_LISTENERS
              value: PLAINTEXT://kafka-service.kv-mall-infra:9092
            - name: KAFKA_CFG_LISTENERS
              value: PLAINTEXT://:9092,CONTROLLER://:9093
            - name: KAFKA_CFG_LISTENER_SECURITY_PROTOCOL_MAP
              value: CONTROLLER:PLAINTEXT,PLAINTEXT:PLAINTEXT
            - name: KAFKA_CFG_CONTROLLER_QUORUM_VOTERS
              value: 0@127.0.0.1:9093
            - name: KAFKA_CFG_CONTROLLER_LISTENER_NAMES
              value: CONTROLLER
            - name: KAFKA_CFG_AUTO_CREATE_TOPICS_ENABLE
              value: 'true'
          ports:
            - containerPort: 9092
            - containerPort: 9093
      restartPolicy: Always
---
apiVersion: v1
kind: Service
metadata:
  name: kafka-service
  namespace: kv-mall-infra
  labels:
    io.kompose.service: kafka
  annotations:
    kompose.cmd: kompose convert -f docker-compose.yml
    kompose.version: 1.28.0 (HEAD)
spec:
  selector:
    io.kompose.service: kafka
  ports:
    - name: '9092'
      port: 9092
      targetPort: 9092
    - name: '9093'
      port: 9093
      targetPort: 9093
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: memcached
  namespace: kv-mall-infra
spec:
  selector:
    matchLabels:
      app: memcached
  replicas: 1
  template:
    metadata:
      labels:
        app: memcached
    spec:
      containers:
        - name: memcached
          image: memcached:1.6.22-alpine
          ports:
            - containerPort: 11211
---
apiVersion: v1
kind: Service
metadata:
  name: memcached
  namespace: kv-mall-infra
spec:
  selector:
    app: memcached
  ports:
    - port: 11211
      targetPort: 11211
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: postgres
  namespace: kv-mall-infra
  labels:
    app: postgres
spec:
  selector:
    matchLabels:
      app: postgres
  template:
    metadata:
      labels:
        app: postgres
    spec:
      containers:
        - name: postgres
          image: postgres:latest
          env:
            - name: POSTGRES_USER
              value: postgres
            - name: POSTGRES_PASSWORD
              value: postgres
            - name: POSTGRES_DB
              value: postgres
          ports:
            - containerPort: 5432
---
apiVersion: v1
kind: Service
metadata:
  name: postgres
  namespace: kv-mall-infra
spec:
  selector:
    app: postgres
  ports:
    - protocol: TCP
      port: 5432
      targetPort: 5432
